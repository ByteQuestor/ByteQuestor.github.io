<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>一篇学习k8s的记录 | 王子阳の主页</title><meta name="author" content="王子阳"><meta name="copyright" content="王子阳"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="加深对k8s的理解">
<meta property="og:type" content="article">
<meta property="og:title" content="一篇学习k8s的记录">
<meta property="og:url" content="http://example.com/2024/09/21/%E4%B8%80%E7%AF%87%E5%AD%A6%E4%B9%A0k8s%E7%9A%84%E8%AE%B0%E5%BD%95/index.html">
<meta property="og:site_name" content="王子阳の主页">
<meta property="og:description" content="加深对k8s的理解">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://raw.gitmirror.com/ByteQuestor/picture/main/kubernetes/k8s.jpg">
<meta property="article:published_time" content="2024-09-21T08:29:14.000Z">
<meta property="article:modified_time" content="2024-11-13T03:55:15.966Z">
<meta property="article:author" content="王子阳">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.gitmirror.com/ByteQuestor/picture/main/kubernetes/k8s.jpg"><link rel="shortcut icon" href="https://raw.gitmirror.com//ByteQuestor/picture/main/myhead.png"><link rel="canonical" href="http://example.com/2024/09/21/%E4%B8%80%E7%AF%87%E5%AD%A6%E4%B9%A0k8s%E7%9A%84%E8%AE%B0%E5%BD%95/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=5.0.0-b2"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.6.0/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        if (name && globalFn[key][name]) return
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":false},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.12.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '一篇学习k8s的记录',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-11-13 03:55:15'
}</script><meta name="generator" content="Hexo 7.3.0"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://raw.gitmirror.com//ByteQuestor/picture/main/myhead.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://raw.gitmirror.com/ByteQuestor/picture/main/kubernetes/k8s.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">王子阳の主页</span></a><a class="nav-page-title" href="/"><span class="site-name">一篇学习k8s的记录</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友情链接链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">一篇学习k8s的记录</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-09-21T08:29:14.000Z" title="发表于 2024-09-21 08:29:14">2024-09-21</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-13T03:55:15.966Z" title="更新于 2024-11-13 03:55:15">2024-11-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>原文链接：<a target="_blank" rel="noopener" href="https://k8s.easydoc.net/docs/dRiQjyTY/28366845/6GiNOzyZ/9EX8Cp45">📚 Kubernetes（K8S）简介 - K8S 教程 - 易文档 (easydoc.net)</a></p>
<h1 id="k8s简介"><a href="#k8s简介" class="headerlink" title="k8s简介"></a>k8s简介</h1><h2 id="部署应用的方案"><a href="#部署应用的方案" class="headerlink" title="部署应用的方案"></a>部署应用的方案</h2><ul>
<li>传统部署<br>直接在物理机上部署，机器资源分配不好控制，如果出现bug，可能机器的大部分资源被某个应用占用，导致其他应用无法正常运行，无法做到应用隔离</li>
<li>虚拟机部署<br>在物理机上运行多个虚拟机，每个虚拟机都是完整独立的系统，性能损耗大</li>
<li>容器部署<br>所有容器共享主机，轻量级的虚拟机，性能损耗小，资源隔离，CPU和内存可按需分配</li>
</ul>
<h2 id="什么时候需要k8s"><a href="#什么时候需要k8s" class="headerlink" title="什么时候需要k8s"></a>什么时候需要k8s</h2><p>如果应用只是跑在一台机器，<code>docker + docker-compose</code></p>
<p>如果应用跑在3,4台机器上，每台机器单独配置运行环境 + 负载均衡其；</p>
<p>当应用访问数不断增加，机器逐渐增加到<strong>几十上千台</strong>，进行<strong>加机器、软件更新、版本回滚</strong>都会很麻烦</p>
<p>k8s就是可以一个命令搞定这些麻烦事，不停机的灰度更新，确保高可用、高性能、高扩展</p>
<h2 id="k8s集群架构"><a href="#k8s集群架构" class="headerlink" title="k8s集群架构"></a>k8s集群架构</h2><p>最少要两台机器</p>
<ul>
<li>主机点(master)<br><strong>控制平台，不需要很高性能</strong>，不跑任务，通常一个就可以了，也可以多开提高集群可用度</li>
<li>工作节点(worker)<br>可以说虚拟机或物理机，任务都在这里跑，机器要性能好，通常有多个，每个工作节点都由主节点管理<br>《插入手绘图》</li>
</ul>
<h2 id="重要概念Pod（豆荚）"><a href="#重要概念Pod（豆荚）" class="headerlink" title="重要概念Pod（豆荚）"></a>重要概念Pod（豆荚）</h2><p>k8s调度，管理的最小单位，主节点负责考量负载自动调度Pod到哪个**节点(worker)**运行</p>
<ul>
<li>一个<strong>Pod可以包含一个或多个容器</strong></li>
<li>每个Pod都有自己的虚拟IP</li>
<li>一个工作节点有多个Pod</li>
</ul>
<blockquote>
<p>总结：&#96;&#96;worker<code>包含</code>pod<code>，</code>pod&#96;包含容器</p>
</blockquote>
<h2 id="k8s组件"><a href="#k8s组件" class="headerlink" title="k8s组件"></a>k8s组件</h2><ul>
<li><code>kube-apiserver</code>API服务器，公开了<code>kubernetes API</code></li>
<li><code>etcd</code>键值数据库，可以作为保存k8s所有集群数据的后台数据库</li>
<li><code>kube-scheduler</code>调度<code>Pod</code>到哪个节点运行</li>
<li><code>kube-controller</code>集群控制器</li>
<li><code>cloud-controller</code>与云服务商交互</li>
</ul>
<h1 id="安装k8s集群"><a href="#安装k8s集群" class="headerlink" title="安装k8s集群"></a>安装k8s集群</h1><h2 id="主机名映射"><a href="#主机名映射" class="headerlink" title="主机名映射"></a>主机名映射</h2><h2 id="关闭SElinux-防护墙"><a href="#关闭SElinux-防护墙" class="headerlink" title="关闭SElinux &amp; 防护墙"></a>关闭SElinux &amp; 防护墙</h2><h2 id="添加安装源"><a href="#添加安装源" class="headerlink" title="添加安装源"></a>添加安装源</h2><p>建议安装版本不超过<code>1.24</code>，因为<code>1.24</code>以后默认不支持<code>docker</code>了，得用<code>podman</code>或单独安装插件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Centos的</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 k8s 安装源</span></span><br><span class="line">cat &lt;&lt;EOF &gt; kubernetes.repo</span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=0</span><br><span class="line">repo_gpgcheck=0</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line">mv kubernetes.repo /etc/yum.repos.d/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 Docker 安装源</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>

<h2 id="安装所需组件（所有节点）"><a href="#安装所需组件（所有节点）" class="headerlink" title="安装所需组件（所有节点）"></a>安装所需组件（所有节点）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y kubelet-1.22.4 kubectl-1.22.4 kubeadm-1.22.4 docker-ce</span><br></pre></td></tr></table></figure>

<h2 id="启动-kubelet、docker，并设置开机启动（所有节点）"><a href="#启动-kubelet、docker，并设置开机启动（所有节点）" class="headerlink" title="启动 kubelet、docker，并设置开机启动（所有节点）"></a>启动 kubelet、docker，并设置开机启动（所有节点）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl enable kubelet</span><br><span class="line">systemctl start kubelet</span><br><span class="line">systemctl enable docker</span><br><span class="line">systemctl start docker</span><br></pre></td></tr></table></figure>

<h2 id="修改-docker-配置（所有节点）"><a href="#修改-docker-配置（所有节点）" class="headerlink" title="修改 docker 配置（所有节点）"></a>修改 docker 配置（所有节点）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubernetes 官方推荐 docker 等使用 systemd 作为 cgroupdriver，否则 kubelet 启动不了</span></span><br><span class="line">cat &lt;&lt;EOF &gt; daemon.json</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://ud6340vz.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">mv daemon.json /etc/docker/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启生效</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

<h2 id="用-kubeadm-初始化集群（仅在主节点跑）"><a href="#用-kubeadm-初始化集群（仅在主节点跑）" class="headerlink" title="用 kubeadm 初始化集群（仅在主节点跑）"></a>用 <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/setup-tools/kubeadm/">kubeadm</a> 初始化集群（仅在主节点跑）</h2><p><code>token</code>是这条<code>init</code>命令生产的，在<code>log</code>里有</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">初始化集群控制台 Control plane</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">失败了可以用 kubeadm reset 重置</span></span><br><span class="line">kubeadm init --image-repository=registry.aliyuncs.com/google_containers</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">记得把 kubeadm <span class="built_in">join</span> xxx 保存起来</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">忘记了重新获取：kubeadm token create --print-join-command</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制授权文件，以便 kubectl 可以有权限访问集群</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果你其他节点需要访问集群，需要从主节点复制这个文件过去其他节点</span></span><br><span class="line">mkdir -p $HOME/.kube</span><br><span class="line">cp -i /etc/kubernetes/admin.conf $HOME/.kube/config</span><br><span class="line">chown $(id -u):$(id -g) $HOME/.kube/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在其他机器上创建 ~/.kube/config 文件也能通过 kubectl 访问到集群</span></span><br></pre></td></tr></table></figure>



<h2 id="把工作节点加入集群（只在工作节点跑）"><a href="#把工作节点加入集群（只在工作节点跑）" class="headerlink" title="把工作节点加入集群（只在工作节点跑）"></a>把工作节点加入集群（只在工作节点跑）</h2><p>下面这条命令，在master安装成功后会提供，只需要直接复制即可</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm join 172.16.32.10:6443 --token xxx --discovery-token-ca-cert-hash xxx</span><br></pre></td></tr></table></figure>



<h2 id="安装网络插件，否则-node-是-NotReady-状态（主节点跑）"><a href="#安装网络插件，否则-node-是-NotReady-状态（主节点跑）" class="headerlink" title="安装网络插件，否则 node 是 NotReady 状态（主节点跑）"></a>安装网络插件，否则 node 是 NotReady 状态（主节点跑）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">很有可能国内网络访问不到这个资源，你可以网上找找国内的源安装 flannel</span></span><br><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果上面的插件安装失败，可以选用 Weave，下面的命令二选一就可以了。</span></span><br><span class="line">kubectl apply -f https://github.com/weaveworks/weave/releases/download/v2.8.1/weave-daemonset-k8s.yaml</span><br><span class="line">kubectl apply -f http://static.corecore.cn/weave.v2.8.1.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更多其他网路插件查看下面介绍，自行网上找 yaml 安装</span></span><br><span class="line">https://blog.csdn.net/ChaITSimpleLove/article/details/117809007</span><br></pre></td></tr></table></figure>



<hr>
<h1 id="部署应用到集群中"><a href="#部署应用到集群中" class="headerlink" title="部署应用到集群中"></a>部署应用到集群中</h1><h2 id="简单部署"><a href="#简单部署" class="headerlink" title="简单部署"></a>简单部署</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run testApp --image=$镜像</span><br></pre></td></tr></table></figure>

<h2 id="Pod"><a href="#Pod" class="headerlink" title="Pod"></a>Pod</h2><p>将YAML转为JSON可以更清楚地看到，每个缩进都是一个大括号，他们就是一组资源</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-pod</span>	<span class="comment"># pod的名字</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 定义容器，可以多个</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-k8s</span> <span class="comment"># 容器名字，容器是运行在pod里面的</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1</span> <span class="comment"># 镜像</span></span><br></pre></td></tr></table></figure>

<p>部署</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f $YAML文件</span><br></pre></td></tr></table></figure>

<h2 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h2><p>原文参考图<br><img src="https://cos.easydoc.net/46901064/files/kwpt8p8o.png" alt="参考图"></p>
<p>每次部署一个Pod很不方便</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span>	<span class="comment"># 这个可以立即为直接建立一个组，就是这个组将部署多少个资源</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 部署名字</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span>	<span class="comment"># 运行的pod数量</span></span><br><span class="line">  <span class="comment"># 用来查找关联的 Pod，所有标签都匹配才行</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">test-k8s</span></span><br><span class="line">  <span class="comment"># 定义 Pod 相关数据</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">test-k8s</span>	 <span class="comment"># 注意这个标签，一定要跟selector 里的标签对应上</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment"># 定义容器，可以多个</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-k8s</span> <span class="comment"># 容器名字，这个不需要跟其他的一样，因为这是pod内部的容器</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">ccr.ccs.tencentyun.com/k8s-tutorial/test-k8s:v1</span> <span class="comment"># 镜像</span></span><br></pre></td></tr></table></figure>

<p>注意：Pod部署我们起什么名字就是什么名字，Deployment部署，会在我们起的名字后加一段随机字符以避免重复</p>
<p><code>Pod</code>部署和<code>Deployment</code>部署的结果都是一样的</p>
<p><strong>唯一的区别是</strong>，<code>Deployment</code>部署的将会有此<code>yaml</code>文件统一管理，如需变化，只需要更改<code>yaml</code>文件再次<code>apply</code>即可</p>
<p>这样创建的资源，可以以下命令查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是所有的pod，包括直接创建的 pod 和 deployment部署</span> </span><br><span class="line">kubectl get pod</span><br><span class="line">kubectl get pod -o wide</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">也可以直接看Deployment(部署)</span></span><br><span class="line">kubectl get deployment # 这样就看到了我们所有的Deployment及其pod概览</span><br></pre></td></tr></table></figure>

<p>查看pod详细状态</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe $podname</span><br></pre></td></tr></table></figure>

<p>查看pod日志</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs/$podname</span><br><span class="line">kubectl logs/$podname -f	# 持续查看</span><br></pre></td></tr></table></figure>

<p>进入pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it $podname</span><br><span class="line">kubectl exec -it $podname -c $容器名字</span><br></pre></td></tr></table></figure>

<p>删除Deployment</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete deployment $DeploymentName</span><br></pre></td></tr></table></figure>

<p>重新Deployment</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout restart deployment $DeploymentName</span><br></pre></td></tr></table></figure>

<p>跟<code>docker</code>一样，只不过把<code>docker</code>换成了<code>kubectl</code></p>
<h2 id="一些好用的命令"><a href="#一些好用的命令" class="headerlink" title="一些好用的命令"></a>一些好用的命令</h2><h3 id="命令行调度pod"><a href="#命令行调度pod" class="headerlink" title="命令行调度pod"></a>命令行调度pod</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl scale deployment $DeployName --replicas=10</span><br></pre></td></tr></table></figure>

<h3 id="命令行绑定端口"><a href="#命令行绑定端口" class="headerlink" title="命令行绑定端口"></a>命令行绑定端口</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl port-forward $PodName 8888:80 # 将Pod的 80 端口绑定到本机 8888 </span><br></pre></td></tr></table></figure>

<h3 id="命令行修改镜像"><a href="#命令行修改镜像" class="headerlink" title="命令行修改镜像"></a>命令行修改镜像</h3><p><code>--record</code> 表示把这个命令记录到操作历史中，就可以回退了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl set image deployment $DeployMent $ContainerName=$Image --record</span><br></pre></td></tr></table></figure>

<h3 id="回滚操作"><a href="#回滚操作" class="headerlink" title="回滚操作"></a>回滚操作</h3><p>直接修改我们的镜像，不会杀掉以前的Pod，直到我们的新镜像完全部署才会杀掉以前的Pod</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看我们有多少可以回滚</span></span><br><span class="line">kubectl rollout history deployment $DeploymentName</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回退上一个版本（无需指定）,不会杀掉当前运行的pod，直到我们回滚的pod全部成功运行</span></span><br><span class="line">kubectl rollout undo deployment $DeploymentName</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回退后，同样会出现一个版本，这样如果再不指定版本就容易回滚容器回滚到错误的</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回退到 1 版本（注意这个版本是<span class="built_in">history</span>的版本号，而不是DeploymentName的版本号）</span></span><br><span class="line">kubectl rollout undo deployment $DeploymentName --to-revision=1</span><br></pre></td></tr></table></figure>

<h3 id="暂停和恢复【冷门】"><a href="#暂停和恢复【冷门】" class="headerlink" title="暂停和恢复【冷门】"></a>暂停和恢复【冷门】</h3><p>感觉太冷门了，用不上，记录一下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">暂停运行，暂停后，对 deployment 的修改不会立刻生效，恢复后才应用设置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">比如上面的命令行修改镜像，先暂停的话，直到恢复后才会生效</span></span><br><span class="line">kubectl rollout pause deployment $DeploymentName</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在这两天命令中间做操作，不会生效，等恢复后才会生效</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">恢复</span></span><br><span class="line">kubectl rollout resume deployment $DeploymentName</span><br></pre></td></tr></table></figure>

<h3 id="输出到文件【冷门】"><a href="#输出到文件【冷门】" class="headerlink" title="输出到文件【冷门】"></a>输出到文件【冷门】</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">输出到文件</span></span><br><span class="line">kubectl get deployment $DeploymentName -o yaml &gt;&gt; app2.yaml</span><br></pre></td></tr></table></figure>

<h3 id="删除全部资源【冷门】"><a href="#删除全部资源【冷门】" class="headerlink" title="删除全部资源【冷门】"></a>删除全部资源【冷门】</h3><blockquote>
<p><code>注意：</code>删的是全部资源</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除全部资源</span></span><br><span class="line">kubectl delete all --all</span><br></pre></td></tr></table></figure>

<h2 id="YAML指定某个节点运行"><a href="#YAML指定某个节点运行" class="headerlink" title="YAML指定某个节点运行"></a>YAML指定某个节点运行</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">env:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">nodeSelector:</span></span><br><span class="line">    <span class="attr">disktype:</span> <span class="string">ssd</span></span><br></pre></td></tr></table></figure>

<p>可以更清楚地看到，这个缩进的影响范围，</p>
<h2 id="下节预告"><a href="#下节预告" class="headerlink" title="下节预告"></a>下节预告</h2><h3 id="工作负载分类【了解】"><a href="#工作负载分类【了解】" class="headerlink" title="工作负载分类【了解】"></a>工作负载分类【了解】</h3><ul>
<li>Deployment<br>适合无状态应用，所有pod等价，可替代</li>
<li>StatefulSet<br>有状态的应用，适合数据库这种类型。</li>
<li>DaemonSet<br>在每个节点上跑一个 Pod，可以用来做节点监控、节点日志收集等</li>
<li>Job &amp; CronJob<br>Job 用来表达的是一次性的任务，而 CronJob 会根据其时间规划反复运行。</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/">文档</a></p>
<h3 id="现存问题"><a href="#现存问题" class="headerlink" title="现存问题"></a>现存问题</h3><ul>
<li>每次只能访问一个 pod，没有负载均衡自动转发到不同 pod</li>
<li>访问还需要端口转发</li>
<li>Pod 重创后 IP 变了，名字也变了</li>
</ul>
<p>这就是<code>Service</code>要做的事情</p>
<hr>
<h1 id="Service"><a href="#Service" class="headerlink" title="Service"></a>Service</h1><h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><ul>
<li><code>Service</code>通过<code>label</code>关联对应的<code>Pod</code></li>
<li><code>Service</code>生命周期不限<code>Pod</code>绑定,不会因为<code>Pod</code>重创改变<code>IP</code></li>
<li>提供了负载均衡功能，自动转发流量到不同<code>Pod</code></li>
<li>可对集群外部提供访问端口</li>
<li>集群内部可通过服务名字访问</li>
</ul>
<p><img src="https://cos.easydoc.net/46901064/files/kwpuoh0h.png" alt="service特性"></p>
<h2 id="创建Service"><a href="#创建Service" class="headerlink" title="创建Service"></a>创建Service</h2><p>关于服务类型的介绍</p>
<ul>
<li><p><code>ClusterIP</code>【集群内部访问】（可以进入到 Pod 里面访问）</p>
</li>
<li><p><code>NodePort</code>【节点可访问】（换成这个可暴露端口后访问）</p>
</li>
<li><p><code>LoadBalancer</code>【负载均衡模式】（需要负载均衡器才能使用）</p>
</li>
</ul>
<p>服务的默认类型是<code>ClusterIP</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec -it pod-name -- bash</span><br><span class="line">curl http://test-k8s:8080</span><br></pre></td></tr></table></figure>

<p>如果要在集群外部访问，可以通过端口转发实现（只适合临时测试用）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl port-forward service/test-k8s 8888:8080</span><br></pre></td></tr></table></figure>

<p><code>YAML</code>文件解析</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-k8s</span> <span class="comment"># 本 Service 的名字</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-k8s</span>	 <span class="comment"># 本 Service 的要集结哪些 pod</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span>	<span class="comment"># 服务类型</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span>        <span class="comment"># 本 Service 的端口,就是外部将要访问的端口</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span>  <span class="comment"># 容器端口，被转发过去的端口</span></span><br></pre></td></tr></table></figure>

<p>应用服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f service.yaml</span><br></pre></td></tr></table></figure>

<p>查看服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc</span><br></pre></td></tr></table></figure>

<h3 id="对外暴露服务-负载均衡"><a href="#对外暴露服务-负载均衡" class="headerlink" title="对外暴露服务 &amp; 负载均衡"></a>对外暴露服务 &amp; 负载均衡</h3><p>上面是通过端口转发的方式可以在外面访问到集群里的服务</p>
<p>如果想要直接把集群服务暴露出来，我们可以使用<code>NodePort</code> 和 <code>Loadbalancer</code> 类型的 Service，此时也具有了负载均衡的效果</p>
<p><code>Loadbalancer</code> 也可以对外提供服务，这需要一个负载均衡器的支持，因为它需要生成一个新的 IP 对外服务，否则状态就一直是 pendding，这个很少用了，后面会有<strong>更高端的 Ingress 来代替它</strong>。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-k8s</span></span><br><span class="line">  <span class="comment"># 默认 ClusterIP 集群内可访问，NodePort 节点可访问，LoadBalancer 负载均衡模式（需要负载均衡器才可用）</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span>	<span class="comment"># 需要新增节点端口</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span>        <span class="comment"># 本 Service 的端口</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span>  <span class="comment"># 容器端口</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31000</span>   <span class="comment"># 节点端口，范围固定 30000 ~ 32767</span></span><br></pre></td></tr></table></figure>

<h2 id="多端口"><a href="#多端口" class="headerlink" title="多端口"></a>多端口</h2><p>对于某些 Service，需要公开多个端口。k8s允许为 Service 对象配置多个端口定义。</p>
<p> 为 Service 使用多个端口时，必须为所有端口提供名称，以使它们无歧义</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">test-k8s</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8080</span>        <span class="comment"># 本 Service 的端口</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-k8s</span>    <span class="comment"># 必须配置</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span>  <span class="comment"># 容器端口</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">31000</span>   <span class="comment"># 节点端口，范围固定 30000 ~ 32767</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">8090</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">test-other</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8090</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">32000</span></span><br></pre></td></tr></table></figure>



<h2 id="本节内容"><a href="#本节内容" class="headerlink" title="本节内容"></a>本节内容</h2><h3 id="ClusterIP"><a href="#ClusterIP" class="headerlink" title="ClusterIP"></a>ClusterIP</h3><p>默认的，仅在集群内可用</p>
<h3 id="NodePort"><a href="#NodePort" class="headerlink" title="NodePort"></a>NodePort</h3><p>暴露端口到节点，提供了集群外部访问的入口<br>端口范围固定 30000 ~ 32767</p>
<h3 id="LoadBalancer"><a href="#LoadBalancer" class="headerlink" title="LoadBalancer"></a>LoadBalancer</h3><p>需要负载均衡器（通常都需要云服务商提供，裸机可以安装 <a target="_blank" rel="noopener" href="https://metallb.universe.tf/">METALLB</a> 测试）<br>会额外生成一个 IP 对外服务，后续会有更高级的<code>Ingress</code><br>K8S 支持的负载均衡器：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/service/#internal-load-balancer">负载均衡器</a></p>
<h3 id="Headless"><a href="#Headless" class="headerlink" title="Headless"></a>Headless</h3><p>适合数据库<br>clusterIp 设置为 None 就变成 Headless 了，不会再分配 IP，后面会再讲到具体用法</p>
<hr>
<h1 id="StatefuSet"><a href="#StatefuSet" class="headerlink" title="StatefuSet"></a>StatefuSet</h1><h2 id="什么是StatefuSet"><a href="#什么是StatefuSet" class="headerlink" title="什么是StatefuSet"></a>什么是StatefuSet</h2><p><code>StatefulSet </code>是用来<strong>管理有状态的应用</strong>，例如<strong>数据库</strong>。</p>
<p>前面部署的应用，都是<strong>不需要存储数据，不需要记住状态</strong>的，可以<strong>随意扩充副本</strong>，每个副本都是一样的，可替代的。</p>
<p>而像<strong>数据库、Redis</strong>这类有状态的，不能随意扩充副本的，<code>StatefulSet </code>会固定每个 Pod 的名字。</p>
<h2 id="StatefulSet-特性"><a href="#StatefulSet-特性" class="headerlink" title="StatefulSet 特性"></a>StatefulSet 特性</h2><ul>
<li>Service 的 <code>CLUSTER-IP</code> 是空的，Pod 名字也是固定的。</li>
<li>Pod 创建和销毁是有序的，创建是顺序的，销毁是逆序的。</li>
<li>Pod 重建不会改变名字，除了IP，所以不要用IP直连</li>
</ul>
<h2 id="部署-StatefulSet-类型的-Mongodb"><a href="#部署-StatefulSet-类型的-Mongodb" class="headerlink" title="部署 StatefulSet 类型的 Mongodb"></a>部署 StatefulSet 类型的 Mongodb</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongodb</span>	<span class="comment"># 用来匹配 POd</span></span><br><span class="line"><span class="comment"># 下面就是要匹配的pod（是会起的）</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongodb</span> <span class="comment"># pod名字</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo</span> <span class="comment"># pod里容器的名字</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mongo:4.4</span></span><br><span class="line">          <span class="comment"># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment"># 下面用一个 Service 统一一个入口来访问</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongodb</span>	<span class="comment"># 这个选择的是 pod的标签，所有拥有此标签的会被 Service 统一管理</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="comment"># HeadLess</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span>	<span class="comment"># 这样就会通过服务名字来访问</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">27017</span></span><br></pre></td></tr></table></figure>

<p>创建</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f mongo.yaml</span><br></pre></td></tr></table></figure>

<p>查看</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod</span><br><span class="line">kubectl get svc</span><br><span class="line">kubectl get statefulset</span><br></pre></td></tr></table></figure>

<p><code>Endpoint</code>s 会多一个 <code>hostname</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get endpoints mongodb -o yaml</span><br></pre></td></tr></table></figure>

<p>访问时，如果直接使用 <code>Service </code>名字连接，会随机转发请求<br>要连接指定 Pod，可以这样<code>pod-name.service-name</code>,运行一个临时 Pod 连接数据测试下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl run mongodb-client --rm --tty -i --restart=&#x27;Never&#x27; --image docker.io/bitnami/mongodb:4.4.10-debian-10-r20 --command -- bash</span><br></pre></td></tr></table></figure>

<h3 id="Web-应用连接-Mongodb"><a href="#Web-应用连接-Mongodb" class="headerlink" title="Web 应用连接 Mongodb"></a>Web 应用连接 Mongodb</h3><p>在集群内部，可以通过服务名字访问到不同的服务，</p>
<p>进入我们临时Pod，指定连接第一个</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongo --host mongodb-0.mongodb</span><br></pre></td></tr></table></figure>

<p>第二个第三个都是这样，之所以通过名字，是因为IP会变，但是名字不会变</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>起的三个服务各自独立</li>
<li>重建后数据丢失</li>
</ul>
<p>下一节<strong>数据持久化</strong>解决</p>
<h1 id="数据持久化"><a href="#数据持久化" class="headerlink" title="数据持久化"></a>数据持久化</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>kubernetes 集群不会处理数据的存储，可以为数据库挂载一个磁盘来确保数据的安全。可以选择云存储、本地磁盘、NFS。</p>
<ul>
<li>本地磁盘：可以挂载某个节点上的目录，但是这需要限定 pod 在这个节点上运行</li>
<li>云存储：不限定节点，不受集群影响，安全稳定；需要云服务商提供，裸机集群是没有的。</li>
<li>NFS：不限定节点，不受集群影响</li>
</ul>
<blockquote>
<p>综上所述，还是买云存储最好</p>
</blockquote>
<h2 id="hostPath-挂载"><a href="#hostPath-挂载" class="headerlink" title="hostPath 挂载"></a>hostPath 挂载</h2><p>把节点上的一个目录挂载到 Pod，但是已经不推荐使用了。配置方式简单，但是<strong>需要手动指定 Pod 跑在某个固定的节点</strong>。不适用于多节点集群。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mongo:4.4</span></span><br><span class="line">          <span class="comment"># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="comment"># ---------------- 以下是新加入的部分 ---------------------- #        </span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/db</span> <span class="comment"># 容器里面的挂载路径</span></span><br><span class="line">              <span class="attr">name:</span> <span class="string">mongo-data</span>    <span class="comment"># 卷名字，必须跟下面定义的名字一致</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo-data</span>              <span class="comment"># 卷名字</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/mongo-data</span>      <span class="comment"># 节点上的路径</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span>     <span class="comment"># 指向一个目录，不存在时自动创建</span></span><br></pre></td></tr></table></figure>

<h2 id="存储介绍"><a href="#存储介绍" class="headerlink" title="存储介绍"></a>存储介绍</h2><p>下图有一个错误</p>
<p><img src="https://cos.easydoc.net/46901064/files/kwrmidne.png" alt="存储抽象"></p>
<h3 id="Persistent-Volume-Claim-PVC"><a href="#Persistent-Volume-Claim-PVC" class="headerlink" title="Persistent Volume Claim (PVC)"></a>Persistent Volume Claim (PVC)</h3><p>对存储需求的一个申明，可以理解为一个申请单，系统根据这个申请单去找一个合适的 PV，还可以根据 PVC 自动创建 PV。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodata</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;local-storage&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br></pre></td></tr></table></figure>

<h3 id="Persistent-Volume-PV"><a href="#Persistent-Volume-PV" class="headerlink" title="Persistent Volume (PV)"></a>Persistent Volume (PV)</h3><p>描述卷的具体信息，例如磁盘大小，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#access-modes">访问模式</a>。<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/">文档</a>，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes">类型</a>，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#local">Local 示例</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodata</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span>  <span class="comment"># Filesystem（文件系统） Block（块）</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span>       <span class="comment"># 卷可以被一个节点以读写方式挂载</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/root/data</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="comment"># 通过 hostname 限定在某个节点创建存储卷</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">node2</span></span><br></pre></td></tr></table></figure>

<h3 id="Storage-Class-SC"><a href="#Storage-Class-SC" class="headerlink" title="Storage Class (SC)"></a>Storage Class (SC)</h3><p>将存储卷划分为不同的种类，例如：SSD，普通磁盘，本地磁盘，按需使用。<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">文档</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">slow</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/aws-ebs</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">io1</span></span><br><span class="line">  <span class="attr">iopsPerGB:</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">  <span class="attr">fsType:</span> <span class="string">ext4</span></span><br></pre></td></tr></table></figure>

<h2 id="本地存储"><a href="#本地存储" class="headerlink" title="本地存储"></a>本地存储</h2><p>所需文件汇总</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mongo:5.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/db</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mongo-data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo-data</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">             <span class="attr">claimName:</span> <span class="string">mongodata</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">27017</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">27017</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">kubernetes.io/no-provisioner</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodata</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">2Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span>  <span class="comment"># Filesystem（文件系统） Block（块）</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span>       <span class="comment"># 卷可以被一个节点以读写方式挂载</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/root/data</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="comment"># 通过 hostname 限定在某个节点创建存储卷</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">kubernetes.io/hostname</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">node2</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodata</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>]</span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;local-storage&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">2Gi</span></span><br></pre></td></tr></table></figure>



<h2 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h2><ul>
<li>当前数据库的连接地址是写死在代码里的，另外还有数据库的密码需要配置。</li>
</ul>
<p>本地太麻烦了，还是买云存储</p>
<h1 id="ConfigMap-Secret"><a href="#ConfigMap-Secret" class="headerlink" title="ConfigMap &amp; Secret"></a>ConfigMap &amp; Secret</h1><h2 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h2><p>比如数据库连接地址，这种可能会根据环境变化的，我们不应该写死在代码里</p>
<p><code>configmap.yaml</code>示例</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-config</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">mongoHost:</span> <span class="string">mongodb-0.mongodb</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">应用</span></span><br><span class="line">kubectl apply -f configmap.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line">kubectl get configmap mongo-config -o yaml</span><br></pre></td></tr></table></figure>



<h2 id="Secret"><a href="#Secret" class="headerlink" title="Secret"></a>Secret</h2><p>一些重要数据，例如密码、<code>TOKEN</code>，可以放到<code>Secret </code>中</p>
<p><code>secret.yaml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line"><span class="comment"># Opaque 用户定义的任意数据，更多类型介绍 https://kubernetes.io/zh/docs/concepts/configuration/secret/#secret-types</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># 数据要 base64。https://tools.fun/base64.html</span></span><br><span class="line">  <span class="attr">mongo-username:</span> <span class="string">bW9uZ291c2Vy</span></span><br><span class="line">  <span class="attr">mongo-password:</span> <span class="string">bW9uZ29wYXNz</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">应用</span></span><br><span class="line">kubectl apply -f secret.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line">kubectl get secret mongo-secret -o yaml</span><br></pre></td></tr></table></figure>

<h2 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">mongodb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mongo</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">mongo:4.4</span></span><br><span class="line">          <span class="comment"># IfNotPresent 仅本地没有镜像时才远程拉，Always 永远都是从远程拉，Never 永远只用本地镜像，本地没有则报错</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line"><span class="comment"># -------------------- 以下是新加入的部分 -------------------------------</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGO_INITDB_ROOT_USERNAME</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">mongo-username</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MONGO_INITDB_ROOT_PASSWORD</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">secretKeyRef:</span></span><br><span class="line">                <span class="attr">name:</span> <span class="string">mongo-secret</span></span><br><span class="line">                <span class="attr">key:</span> <span class="string">mongo-password</span></span><br><span class="line">          <span class="comment"># Secret 的所有数据定义为容器的环境变量，Secret 中的键名称为 Pod 中的环境变量名称</span></span><br><span class="line">          <span class="comment"># envFrom:</span></span><br><span class="line">          <span class="comment"># - secretRef:</span></span><br><span class="line">          <span class="comment">#     name: mongo-secret</span></span><br></pre></td></tr></table></figure>

<h5 id="挂载为文件（更适合证书文件）【了解】"><a href="#挂载为文件（更适合证书文件）【了解】" class="headerlink" title="挂载为文件（更适合证书文件）【了解】"></a>挂载为文件（更适合证书文件）【了解】</h5><p>挂载后，会在容器中对应路径生成文件，一个 key 一个文件，内容就是 value，<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/#using-secrets-as-files-from-a-pod">文档</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/etc/foo&quot;</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">foo</span></span><br><span class="line">    <span class="attr">secret:</span></span><br><span class="line">      <span class="attr">secretName:</span> <span class="string">mysecret</span></span><br></pre></td></tr></table></figure>

<h1 id="Helm-命名空间"><a href="#Helm-命名空间" class="headerlink" title="Helm &amp; 命名空间"></a>Helm &amp; 命名空间</h1><h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><code>Helm</code>类似 npm，pip，docker hub, 可以理解为是一个软件库，可以方便快速的为集群安装一些第三方软件。<br>使用 <code>Helm</code>可以非常方便的就搭建出来 <code>MongoDB </code>&#x2F; <code>MySQL </code>副本集群，<code>YAML </code>文件别人都给写好了，直接使用。<a target="_blank" rel="noopener" href="https://helm.sh/zh/">官网</a>，<a target="_blank" rel="noopener" href="https://artifacthub.io/">应用中心</a></p>
<h2 id="安装-Helm"><a href="#安装-Helm" class="headerlink" title="安装 Helm"></a>安装 Helm</h2><p>安装 <a target="_blank" rel="noopener" href="https://helm.sh/zh/docs/intro/install/">文档</a><br><code>curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash</code></p>
<p>本地有安装包</p>
<h2 id="Helm安装-MongoDB-示例"><a href="#Helm安装-MongoDB-示例" class="headerlink" title="Helm安装 MongoDB 示例"></a>Helm安装 MongoDB 示例</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line"><span class="comment"># 将 Bitnami 的 Helm 仓库添加到本地 Helm 配置中，方便后续安装 MongoDB</span></span><br><span class="line"><span class="string">helm</span> <span class="string">repo</span> <span class="string">add</span> <span class="string">bitnami</span> <span class="string">https://charts.bitnami.com/bitnami</span></span><br><span class="line"><span class="comment"># Helm 安装一个名为 my-mongo 的 MongoDB 集群。默认情况下，这会安装一个单实例 MongoDB</span></span><br><span class="line"><span class="string">helm</span> <span class="string">install</span> <span class="string">my-mongo</span> <span class="string">bitnami/mongodb</span></span><br><span class="line"><span class="comment"># 安装mysql（命令记录）</span></span><br><span class="line"><span class="string">helm</span> <span class="string">install</span> <span class="string">my-mysql</span> <span class="string">bitnami/mysql</span> <span class="string">--set</span> <span class="string">architecture=&quot;replication&quot;,auth.rootPassword=&quot;yourpassword&quot;,auth.replicationPassword=&quot;replicapassword&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定密码和架构</span></span><br><span class="line"><span class="comment"># 将 MongoDB 部署为副本集（replica set）架构，并设置 root 用户密码为 mongopass</span></span><br><span class="line"><span class="string">helm</span> <span class="string">install</span> <span class="string">my-mongo</span> <span class="string">bitnami/mongodb</span> <span class="string">--set</span> <span class="string">architecture=&quot;replicaset&quot;,auth.rootPassword=&quot;mongopass&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line"><span class="comment"># 使用 helm ls 查看已安装的 Helm 发行版，通过 helm delete 删除 my-mongo 这个实例</span></span><br><span class="line"><span class="string">helm</span> <span class="string">ls</span></span><br><span class="line"><span class="string">helm</span> <span class="string">delete</span> <span class="string">my-mongo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看密码</span></span><br><span class="line"><span class="comment"># 查看存储在 Kubernetes Secret 中的 MongoDB root 密码，可以以 JSON 或 YAML 格式输出并保存</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">secret</span> <span class="string">my-mongo-mongodb</span> <span class="string">-o</span> <span class="string">json</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">secret</span> <span class="string">my-mongo-mongodb</span> <span class="string">-o</span> <span class="string">yaml</span> <span class="string">&gt;</span> <span class="string">secret.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 临时运行一个包含 mongo client 的 debian 系统</span></span><br><span class="line"><span class="comment"># 运行一个临时容器进入 MongoDB 客户端环境，使用 bitnami/mongodb 镜像来访问 MongoDB</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">run</span> <span class="string">mongodb-client</span> <span class="string">--rm</span> <span class="string">--tty</span> <span class="string">-i</span> <span class="string">--restart=&#x27;Never&#x27;</span> <span class="string">--image</span> <span class="string">docker.io/bitnami/mongodb:4.4.10-debian-10-r20</span> <span class="string">--command</span> <span class="string">--</span> <span class="string">bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 进去 mongodb</span></span><br><span class="line"><span class="comment"># 使用 MongoDB 客户端登录到 MongoDB 实例，连接地址为 my-mongo-mongodb，使用 root 用户名和密码</span></span><br><span class="line"><span class="string">mongo</span> <span class="string">--host</span> <span class="string">&quot;my-mongo-mongodb&quot;</span> <span class="string">-u</span> <span class="string">root</span> <span class="string">-p</span> <span class="string">mongopass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以转发集群里的端口到宿主机访问 mongodb</span></span><br><span class="line"><span class="comment"># 将集群中的 MongoDB 服务端口 27018 转发到本地主机的 27017，以便可以在本地通过 localhost:27017 访问 MongoDB</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">port-forward</span> <span class="string">svc/my-mongo-mongodb</span> <span class="number">27017</span><span class="string">:27018</span></span><br></pre></td></tr></table></figure>

<p>好处是，可以直接安装高可用，不需要我们手动操作</p>
<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><p>如果一个集群中部署了多个应用，所有应用都在一起，就不太好管理，也可以导致名字冲突等。<br>我们可以使用 <code>namespace </code>把应用划分到不同的命名空间，跟代码里的 namespace 是一个概念，只是为了划分空间。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建命名空间</span></span><br><span class="line">kubectl create namespace testapp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">部署应用到指定的命名空间</span></span><br><span class="line">kubectl apply -f app.yml --namespace testapp</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查询</span></span><br><span class="line">kubectl get pod --namespace kube-system</span><br></pre></td></tr></table></figure>

<p>可以用 <code>kubens</code>快速切换 <code>namespace</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换命名空间</span></span><br><span class="line">kubens kube-system</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回到上个命名空间</span></span><br><span class="line">kubens -</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切换集群</span></span><br><span class="line">kubectx minikube</span><br></pre></td></tr></table></figure>



<h1 id="Ingress"><a href="#Ingress" class="headerlink" title="Ingress"></a>Ingress</h1><h2 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h2><p>Ingress 为外部访问集群提供了一个 <strong>统一</strong> 入口，避免了对外暴露集群端口；<br>功能类似 Nginx，可以根据域名、路径把请求转发到不同的 Service。<br>可以配置 https</p>
<h2 id="跟-LoadBalancer-有什么区别？"><a href="#跟-LoadBalancer-有什么区别？" class="headerlink" title="跟 LoadBalancer 有什么区别？"></a><strong>跟 LoadBalancer 有什么区别？</strong></h2><ul>
<li><p><code>LoadBalancer </code>需要对外暴露端口，不安全</p>
</li>
<li><p>无法根据域名、路径转发流量到不同 <code>Service</code>，多个 <code>Service </code>则需要开多个 <code>LoadBalancer</code>；</p>
</li>
<li><p>功能单一，无法配置 <code>https</code></p>
</li>
</ul>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>要使用 <code>Ingress</code>，需要一个负载均衡器 + <code>Ingress Controller</code></p>
<p>如果是裸机（bare metal) 搭建的集群，需要自己安装一个负载均衡插件，可以安装 <a target="_blank" rel="noopener" href="https://metallb.universe.tf/">METALLB</a></p>
<p>如果是云服务商，会自动给配置，否则外部 IP 会是 “pending” 状态，无法使用。</p>
<p>文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/services-networking/ingress/">Ingress</a></p>
<p>Minikube 中部署 Ingress Controller：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/tasks/access-application-cluster/ingress-minikube/">nginx</a></p>
<p>Helm 安装： <a target="_blank" rel="noopener" href="https://kubernetes.github.io/ingress-nginx/deploy/#quick-start">Nginx</a></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">networking.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">simple-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ingressClassName:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">host:</span> <span class="string">tools.fun</span></span><br><span class="line">    <span class="attr">http:</span></span><br><span class="line">      <span class="attr">paths:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/easydoc</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">service1</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">4200</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/svnbucket</span></span><br><span class="line">        <span class="attr">pathType:</span> <span class="string">Prefix</span></span><br><span class="line">        <span class="attr">backend:</span></span><br><span class="line">          <span class="attr">service:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">service2</span></span><br><span class="line">            <span class="attr">port:</span></span><br><span class="line">              <span class="attr">number:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h1 id="训练方案"><a href="#训练方案" class="headerlink" title="训练方案"></a>训练方案</h1></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a target="_blank" rel="noopener" href="https://github.com/ByteQuestor">王子阳</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://example.com/2024/09/21/%E4%B8%80%E7%AF%87%E5%AD%A6%E4%B9%A0k8s%E7%9A%84%E8%AE%B0%E5%BD%95/">http://example.com/2024/09/21/%E4%B8%80%E7%AF%87%E5%AD%A6%E4%B9%A0k8s%E7%9A%84%E8%AE%B0%E5%BD%95/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="http://example.com" target="_blank">王子阳の主页</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a></div><div class="post-share"><div class="social-share" data-image="https://raw.gitmirror.com/ByteQuestor/picture/main/kubernetes/k8s.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i>赞助</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://raw.gitmirror.com/ByteQuestor/picture/main/paywx.png" target="_blank"><img class="post-qr-code-img" src="https://raw.gitmirror.com/ByteQuestor/picture/main/paywx.png" alt="微信投喂"/></a><div class="post-qr-code-desc">微信投喂</div></li><li class="reward-item"><a href="https://raw.gitmirror.com/ByteQuestor/picture/main/zfbbpay.png" target="_blank"><img class="post-qr-code-img" src="https://raw.gitmirror.com/ByteQuestor/picture/main/zfbbpay.png" alt="支付宝投喂"/></a><div class="post-qr-code-desc">支付宝投喂</div></li></ul></div></div><nav class="pagination-post" id="pagination"><a class="prev-post pull-left" href="/2024/09/29/Hexo%E9%85%8D%E5%90%88GithubAction%E8%87%AA%E5%8A%A8%E5%8C%96%E9%83%A8%E7%BD%B2%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/" title="Hexo配合GithubAction自动化部署个人博客"><img class="cover" src="https://raw.gitmirror.com/ByteQuestor/picture/main/GitHub-Logo.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Hexo配合GithubAction自动化部署个人博客</div></div></a><a class="next-post pull-right" href="/2024/09/19/%E5%9C%A8%E8%85%BE%E8%AE%AF%E4%BA%91%E4%B8%8A%E9%83%A8%E7%BD%B2todo%E5%B9%B6%E9%85%8D%E7%BD%AE%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/" title="在腾讯云上部署todo并配置负载均衡"><img class="cover" src="https://raw.gitmirror.com/ByteQuestor/picture/main/tencent/tencent.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">在腾讯云上部署todo并配置负载均衡</div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a href="/2024/10/02/%E5%9C%A8Centos7-9%E4%B8%8A%E6%89%8B%E5%B7%A5%E9%83%A8%E7%BD%B2k8s/" title="在Centos7.9上手工部署k8s"><img class="cover" src="https://raw.gitmirror.com/ByteQuestor/picture/main/k8s130.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-02</div><div class="title">在Centos7.9上手工部署k8s</div></div></a><a href="/2024/09/17/%E5%9C%A8k8s%E4%B8%8A%E5%AF%B9WeatherForecast%E8%BF%9B%E8%A1%8CAB%E6%B5%8B%E8%AF%95/" title="在k8s上对WeatherForecast进行AB测试"><img class="cover" src="https://raw.gitmirror.com/ByteQuestor/picture/main/WeatherForecast.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-17</div><div class="title">在k8s上对WeatherForecast进行AB测试</div></div></a><a href="/2024/09/17/%E5%9C%A8k8s%E4%B8%8A%E5%AF%B9WeatherForecast%E8%BF%9B%E8%A1%8C%E5%A4%9A%E6%9C%8D%E5%8A%A1%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/" title="在k8s上对WeatherForecast进行多服务灰度发布"><img class="cover" src="https://raw.gitmirror.com/ByteQuestor/picture/main/WeatherForecast.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-17</div><div class="title">在k8s上对WeatherForecast进行多服务灰度发布</div></div></a><a href="/2024/09/17/%E5%9C%A8k8s%E4%B8%8A%E5%AF%B9WeatherForecast%E8%BF%9B%E8%A1%8C%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/" title="在k8s上对WeatherForecast进行灰度发布"><img class="cover" src="https://raw.gitmirror.com/ByteQuestor/picture/main/WeatherForecast.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-17</div><div class="title">在k8s上对WeatherForecast进行灰度发布</div></div></a><a href="/2024/09/16/%E5%9C%A8k8s%E4%B8%8A%E9%83%A8%E7%BD%B2WeatherForecast/" title="在k8s上部署WeatherForecast"><img class="cover" src="https://raw.gitmirror.com/ByteQuestor/picture/main/WeatherForecast.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-16</div><div class="title">在k8s上部署WeatherForecast</div></div></a><a href="/2024/11/03/%E8%AE%B0%E5%BD%95k8s%E5%88%A0%E9%99%A4%E6%B1%A1%E7%82%B9/" title="k8s集群删除污点"><img class="cover" src="https://raw.gitmirror.com/ByteQuestor/picture/main/kubernetes/k8s.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-03</div><div class="title">k8s集群删除污点</div></div></a></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info is-center"><div class="avatar-img"><img src="https://raw.gitmirror.com//ByteQuestor/picture/main/myhead.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">王子阳</div><div class="author-info-description">天地本无全</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">24</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">17</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/ByteQuestor"><i class="fab fa-github"></i><span>Github</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">一定是平时练习总是 差不多 差不多 关键时刻总是差一点</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">k8s简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8%E7%9A%84%E6%96%B9%E6%A1%88"><span class="toc-number">1.1.</span> <span class="toc-text">部署应用的方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E9%9C%80%E8%A6%81k8s"><span class="toc-number">1.2.</span> <span class="toc-text">什么时候需要k8s</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E9%9B%86%E7%BE%A4%E6%9E%B6%E6%9E%84"><span class="toc-number">1.3.</span> <span class="toc-text">k8s集群架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8D%E8%A6%81%E6%A6%82%E5%BF%B5Pod%EF%BC%88%E8%B1%86%E8%8D%9A%EF%BC%89"><span class="toc-number">1.4.</span> <span class="toc-text">重要概念Pod（豆荚）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k8s%E7%BB%84%E4%BB%B6"><span class="toc-number">1.5.</span> <span class="toc-text">k8s组件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%89%E8%A3%85k8s%E9%9B%86%E7%BE%A4"><span class="toc-number">2.</span> <span class="toc-text">安装k8s集群</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BB%E6%9C%BA%E5%90%8D%E6%98%A0%E5%B0%84"><span class="toc-number">2.1.</span> <span class="toc-text">主机名映射</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%B3%E9%97%ADSElinux-%E9%98%B2%E6%8A%A4%E5%A2%99"><span class="toc-number">2.2.</span> <span class="toc-text">关闭SElinux &amp; 防护墙</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%AE%89%E8%A3%85%E6%BA%90"><span class="toc-number">2.3.</span> <span class="toc-text">添加安装源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E6%89%80%E9%9C%80%E7%BB%84%E4%BB%B6%EF%BC%88%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">2.4.</span> <span class="toc-text">安装所需组件（所有节点）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-kubelet%E3%80%81docker%EF%BC%8C%E5%B9%B6%E8%AE%BE%E7%BD%AE%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8%EF%BC%88%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">2.5.</span> <span class="toc-text">启动 kubelet、docker，并设置开机启动（所有节点）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-docker-%E9%85%8D%E7%BD%AE%EF%BC%88%E6%89%80%E6%9C%89%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">2.6.</span> <span class="toc-text">修改 docker 配置（所有节点）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8-kubeadm-%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4%EF%BC%88%E4%BB%85%E5%9C%A8%E4%B8%BB%E8%8A%82%E7%82%B9%E8%B7%91%EF%BC%89"><span class="toc-number">2.7.</span> <span class="toc-text">用 kubeadm 初始化集群（仅在主节点跑）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8A%8A%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E5%8A%A0%E5%85%A5%E9%9B%86%E7%BE%A4%EF%BC%88%E5%8F%AA%E5%9C%A8%E5%B7%A5%E4%BD%9C%E8%8A%82%E7%82%B9%E8%B7%91%EF%BC%89"><span class="toc-number">2.8.</span> <span class="toc-text">把工作节点加入集群（只在工作节点跑）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E6%8F%92%E4%BB%B6%EF%BC%8C%E5%90%A6%E5%88%99-node-%E6%98%AF-NotReady-%E7%8A%B6%E6%80%81%EF%BC%88%E4%B8%BB%E8%8A%82%E7%82%B9%E8%B7%91%EF%BC%89"><span class="toc-number">2.9.</span> <span class="toc-text">安装网络插件，否则 node 是 NotReady 状态（主节点跑）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8%E5%88%B0%E9%9B%86%E7%BE%A4%E4%B8%AD"><span class="toc-number">3.</span> <span class="toc-text">部署应用到集群中</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E9%83%A8%E7%BD%B2"><span class="toc-number">3.1.</span> <span class="toc-text">简单部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod"><span class="toc-number">3.2.</span> <span class="toc-text">Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Deployment"><span class="toc-number">3.3.</span> <span class="toc-text">Deployment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%A5%BD%E7%94%A8%E7%9A%84%E5%91%BD%E4%BB%A4"><span class="toc-number">3.4.</span> <span class="toc-text">一些好用的命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E8%B0%83%E5%BA%A6pod"><span class="toc-number">3.4.1.</span> <span class="toc-text">命令行调度pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%BB%91%E5%AE%9A%E7%AB%AF%E5%8F%A3"><span class="toc-number">3.4.2.</span> <span class="toc-text">命令行绑定端口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BF%AE%E6%94%B9%E9%95%9C%E5%83%8F"><span class="toc-number">3.4.3.</span> <span class="toc-text">命令行修改镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9E%E6%BB%9A%E6%93%8D%E4%BD%9C"><span class="toc-number">3.4.4.</span> <span class="toc-text">回滚操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9A%82%E5%81%9C%E5%92%8C%E6%81%A2%E5%A4%8D%E3%80%90%E5%86%B7%E9%97%A8%E3%80%91"><span class="toc-number">3.4.5.</span> <span class="toc-text">暂停和恢复【冷门】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%88%B0%E6%96%87%E4%BB%B6%E3%80%90%E5%86%B7%E9%97%A8%E3%80%91"><span class="toc-number">3.4.6.</span> <span class="toc-text">输出到文件【冷门】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E5%85%A8%E9%83%A8%E8%B5%84%E6%BA%90%E3%80%90%E5%86%B7%E9%97%A8%E3%80%91"><span class="toc-number">3.4.7.</span> <span class="toc-text">删除全部资源【冷门】</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#YAML%E6%8C%87%E5%AE%9A%E6%9F%90%E4%B8%AA%E8%8A%82%E7%82%B9%E8%BF%90%E8%A1%8C"><span class="toc-number">3.5.</span> <span class="toc-text">YAML指定某个节点运行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E8%8A%82%E9%A2%84%E5%91%8A"><span class="toc-number">3.6.</span> <span class="toc-text">下节预告</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E8%B4%9F%E8%BD%BD%E5%88%86%E7%B1%BB%E3%80%90%E4%BA%86%E8%A7%A3%E3%80%91"><span class="toc-number">3.6.1.</span> <span class="toc-text">工作负载分类【了解】</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E5%AD%98%E9%97%AE%E9%A2%98"><span class="toc-number">3.6.2.</span> <span class="toc-text">现存问题</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Service"><span class="toc-number">4.</span> <span class="toc-text">Service</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%89%B9%E6%80%A7"><span class="toc-number">4.1.</span> <span class="toc-text">特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAService"><span class="toc-number">4.2.</span> <span class="toc-text">创建Service</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E5%A4%96%E6%9A%B4%E9%9C%B2%E6%9C%8D%E5%8A%A1-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">4.2.1.</span> <span class="toc-text">对外暴露服务 &amp; 负载均衡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%AB%AF%E5%8F%A3"><span class="toc-number">4.3.</span> <span class="toc-text">多端口</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E8%8A%82%E5%86%85%E5%AE%B9"><span class="toc-number">4.4.</span> <span class="toc-text">本节内容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ClusterIP"><span class="toc-number">4.4.1.</span> <span class="toc-text">ClusterIP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NodePort"><span class="toc-number">4.4.2.</span> <span class="toc-text">NodePort</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LoadBalancer"><span class="toc-number">4.4.3.</span> <span class="toc-text">LoadBalancer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Headless"><span class="toc-number">4.4.4.</span> <span class="toc-text">Headless</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#StatefuSet"><span class="toc-number">5.</span> <span class="toc-text">StatefuSet</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFStatefuSet"><span class="toc-number">5.1.</span> <span class="toc-text">什么是StatefuSet</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StatefulSet-%E7%89%B9%E6%80%A7"><span class="toc-number">5.2.</span> <span class="toc-text">StatefulSet 特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2-StatefulSet-%E7%B1%BB%E5%9E%8B%E7%9A%84-Mongodb"><span class="toc-number">5.3.</span> <span class="toc-text">部署 StatefulSet 类型的 Mongodb</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-%E5%BA%94%E7%94%A8%E8%BF%9E%E6%8E%A5-Mongodb"><span class="toc-number">5.3.1.</span> <span class="toc-text">Web 应用连接 Mongodb</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98"><span class="toc-number">5.4.</span> <span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">6.</span> <span class="toc-text">数据持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">6.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hostPath-%E6%8C%82%E8%BD%BD"><span class="toc-number">6.2.</span> <span class="toc-text">hostPath 挂载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.3.</span> <span class="toc-text">存储介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Persistent-Volume-Claim-PVC"><span class="toc-number">6.3.1.</span> <span class="toc-text">Persistent Volume Claim (PVC)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Persistent-Volume-PV"><span class="toc-number">6.3.2.</span> <span class="toc-text">Persistent Volume (PV)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Storage-Class-SC"><span class="toc-number">6.3.3.</span> <span class="toc-text">Storage Class (SC)</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E5%AD%98%E5%82%A8"><span class="toc-number">6.4.</span> <span class="toc-text">本地存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%97%AE%E9%A2%98-1"><span class="toc-number">6.5.</span> <span class="toc-text">问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ConfigMap-Secret"><span class="toc-number">7.</span> <span class="toc-text">ConfigMap &amp; Secret</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigMap"><span class="toc-number">7.1.</span> <span class="toc-text">ConfigMap</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Secret"><span class="toc-number">7.2.</span> <span class="toc-text">Secret</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">7.3.</span> <span class="toc-text">使用方法</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8C%82%E8%BD%BD%E4%B8%BA%E6%96%87%E4%BB%B6%EF%BC%88%E6%9B%B4%E9%80%82%E5%90%88%E8%AF%81%E4%B9%A6%E6%96%87%E4%BB%B6%EF%BC%89%E3%80%90%E4%BA%86%E8%A7%A3%E3%80%91"><span class="toc-number">7.3.0.0.1.</span> <span class="toc-text">挂载为文件（更适合证书文件）【了解】</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Helm-%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">8.</span> <span class="toc-text">Helm &amp; 命名空间</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D"><span class="toc-number">8.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-Helm"><span class="toc-number">8.2.</span> <span class="toc-text">安装 Helm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Helm%E5%AE%89%E8%A3%85-MongoDB-%E7%A4%BA%E4%BE%8B"><span class="toc-number">8.3.</span> <span class="toc-text">Helm安装 MongoDB 示例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="toc-number">8.4.</span> <span class="toc-text">命名空间</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ingress"><span class="toc-number">9.</span> <span class="toc-text">Ingress</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8B%E7%BB%8D-1"><span class="toc-number">9.1.</span> <span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%9F-LoadBalancer-%E6%9C%89%E4%BB%80%E4%B9%88%E5%8C%BA%E5%88%AB%EF%BC%9F"><span class="toc-number">9.2.</span> <span class="toc-text">跟 LoadBalancer 有什么区别？</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8"><span class="toc-number">9.3.</span> <span class="toc-text">使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AE%AD%E7%BB%83%E6%96%B9%E6%A1%88"><span class="toc-number">10.</span> <span class="toc-text">训练方案</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/2024/11/13/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1nginx%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" title="记录一次nginx遇到的问题"><img src="https://raw.gitmirror.com/ByteQuestor/picture/main/nginx/nginx.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记录一次nginx遇到的问题"/></a><div class="content"><a class="title" href="/2024/11/13/%E8%AE%B0%E5%BD%95%E4%B8%80%E6%AC%A1nginx%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/" title="记录一次nginx遇到的问题">记录一次nginx遇到的问题</a><time datetime="2024-11-13T11:34:49.000Z" title="发表于 2024-11-13 11:34:49">2024-11-13</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/09/%E8%AE%B0%E5%BD%95k8s%E5%BC%80%E5%8F%91%E8%BF%90%E7%BB%B4%E7%9A%84%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/" title="记录k8s开发运维的环境准备"><img src="https://raw.gitmirror.com/ByteQuestor/picture/main/kubernetes/k8s.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记录k8s开发运维的环境准备"/></a><div class="content"><a class="title" href="/2024/11/09/%E8%AE%B0%E5%BD%95k8s%E5%BC%80%E5%8F%91%E8%BF%90%E7%BB%B4%E7%9A%84%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/" title="记录k8s开发运维的环境准备">记录k8s开发运维的环境准备</a><time datetime="2024-11-09T18:12:57.000Z" title="发表于 2024-11-09 18:12:57">2024-11-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/07/%E8%AE%B0%E5%BD%95%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8github%E5%88%9B%E5%BB%BArelease/" title="记录如何使用github创建release"><img src="https://raw.gitmirror.com/ByteQuestor/picture/main/GitHub-Logo.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记录如何使用github创建release"/></a><div class="content"><a class="title" href="/2024/11/07/%E8%AE%B0%E5%BD%95%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8github%E5%88%9B%E5%BB%BArelease/" title="记录如何使用github创建release">记录如何使用github创建release</a><time datetime="2024-11-07T09:17:38.000Z" title="发表于 2024-11-07 09:17:38">2024-11-07</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/11/03/%E8%AE%B0%E5%BD%95k8s%E5%88%A0%E9%99%A4%E6%B1%A1%E7%82%B9/" title="k8s集群删除污点"><img src="https://raw.gitmirror.com/ByteQuestor/picture/main/kubernetes/k8s.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s集群删除污点"/></a><div class="content"><a class="title" href="/2024/11/03/%E8%AE%B0%E5%BD%95k8s%E5%88%A0%E9%99%A4%E6%B1%A1%E7%82%B9/" title="k8s集群删除污点">k8s集群删除污点</a><time datetime="2024-11-03T15:14:37.000Z" title="发表于 2024-11-03 15:14:37">2024-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/2024/10/25/%E8%AE%B0%E5%BD%95%E5%B8%B8%E7%94%A8%E7%9A%84Markdown%E8%AF%AD%E5%8F%A5/" title="记录常用的Markdown语句"><img src="https://raw.gitmirror.com/ByteQuestor/picture/main/markdown.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="记录常用的Markdown语句"/></a><div class="content"><a class="title" href="/2024/10/25/%E8%AE%B0%E5%BD%95%E5%B8%B8%E7%94%A8%E7%9A%84Markdown%E8%AF%AD%E5%8F%A5/" title="记录常用的Markdown语句">记录常用的Markdown语句</a><time datetime="2024-10-25T17:34:17.000Z" title="发表于 2024-10-25 17:34:17">2024-10-25</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By 王子阳</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=5.0.0-b2"></script><script src="/js/main.js?v=5.0.0-b2"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="I,LOVE,YOU" data-fontsize="25px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>